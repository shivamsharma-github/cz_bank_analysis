// Storage Integration 
// Creating a connection between S3 and snowflake

CREATE OR REPLACE STORAGE INTEGRATION s3_int
TYPE = EXTERNAL_STAGE
STORAGE_PROVIDER = S3
ENABLED = TRUE
STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::315664170695:role/cz_bank_snowpipe_role'
STORAGE_ALLOWED_LOCATIONS = ('s3://czbankanalysis/');

DESC INTEGRATION s3_int;


// File format creation
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1;


//Creating stage
CREATE OR REPLACE STAGE bank_stage
URL = 's3://czbankanalysis'
//CREDENTIALS = (aws_key_id='Enter the key id here'aws_secret_key='Enter secret key here')
FILE_FORMAT = CSV_FORMAT
STORAGE_INTEGRATION = s3_int;

SHOW STAGES;

LIST @bank_stage;


// Now we create snowpipe that will recognise data which is ingested in S3 folders

CREATE OR REPLACE PIPE BANK_SNOWPIPE_DISTRICT AUTO_INGEST = TRUE AS
COPY INTO "CZ_BANK_DB"."PUBLIC"."DISTRICT"
FROM '@bank_stage/district/'
FILE_FORMAT = CSV_FORMAT;


CREATE OR REPLACE PIPE BANK_SNOWPIPE_ACCOUNT AUTO_INGEST = TRUE AS
COPY INTO "CZ_BANK_DB"."PUBLIC"."ACCOUNT"
FROM '@bank_stage/account/'
FILE_FORMAT = CSV_FORMAT;


CREATE OR REPLACE PIPE BANK_SNOWPIPE_TRANSACTIONS AUTO_INGEST = TRUE AS
COPY INTO "CZ_BANK_DB"."PUBLIC"."TRANSACTIONS"
FROM '@bank_stage/transactions/'
FILE_FORMAT = CSV_FORMAT;


CREATE OR REPLACE PIPE BANK_SNOWPIPE_DISPOSITION AUTO_INGEST = TRUE AS
COPY INTO "CZ_BANK_DB"."PUBLIC"."DISPOSITION"
FROM '@bank_stage/disposition/'
FILE_FORMAT = CSV_FORMAT;


CREATE OR REPLACE PIPE BANK_SNOWPIPE_CARD AUTO_INGEST = TRUE AS
COPY INTO "CZ_BANK_DB"."PUBLIC"."CARD"
FROM '@bank_stage/card/'
FILE_FORMAT = CSV_FORMAT;


CREATE OR REPLACE PIPE BANK_SNOWPIPE_ORDERS AUTO_INGEST = TRUE AS
COPY INTO "CZ_BANK_DB"."PUBLIC"."ORDERS"
FROM '@bank_stage/orders/'
FILE_FORMAT = CSV_FORMAT;


CREATE OR REPLACE PIPE BANK_SNOWPIPE_LOAN AUTO_INGEST = TRUE AS
COPY INTO "CZ_BANK_DB"."PUBLIC"."LOAN"
FROM '@bank_stage/loan/'
FILE_FORMAT = CSV_FORMAT;


CREATE OR REPLACE PIPE BANK_SNOWPIPE_CLIENT AUTO_INGEST = TRUE AS
COPY INTO "CZ_BANK_DB"."PUBLIC"."CLIENT"
FROM '@bank_stage/client/'
FILE_FORMAT = CSV_FORMAT;


SHOW PIPES;


SELECT COUNT(*) FROM DISTRICT;
SELECT COUNT(*) FROM ACCOUNT;
SELECT COUNT(*) FROM TRANSACTIONS;
SELECT COUNT(*) FROM DISPOSITION;
SELECT COUNT(*) FROM CARD;
SELECT COUNT(*) FROM ORDERS;
SELECT COUNT(*) FROM LOAN;
SELECT COUNT(*) FROM CLIENT;


// To refresh pipes 

ALTER PIPE BANK_SNOWPIPE_DISTRICT REFRESH;
ALTER PIPE BANK_SNOWPIPE_ACCOUNT REFRESH;
ALTER PIPE BANK_SNOWPIPE_TRANSACTIONS REFRESH;
ALTER PIPE BANK_SNOWPIPE_DISPOSITION REFRESH;
ALTER PIPE BANK_SNOWPIPE_CARD REFRESH;
ALTER PIPE BANK_SNOWPIPE_ORDERS REFRESH;
ALTER PIPE BANK_SNOWPIPE_LOAN REFRESH;
ALTER PIPE BANK_SNOWPIPE_CLIENT REFRESH;



SELECT DISTINCT(YEAR(date)) FROM transactions;

























